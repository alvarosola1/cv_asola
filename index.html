<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Interactivo - √Ålvaro Sola Mart√≠nez</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Carga la clave de API desde el archivo de configuraci√≥n local -->
    <script src="config.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .timeline-item {
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .timeline-item.active {
            background-color: #CAF0F8;
            border-left-color: #0077B6;
        }
        .gemini-modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        .gemini-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 2rem;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 1rem;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0077B6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <main class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-10">
            <h1 id="header-title" class="text-4xl md:text-5xl font-bold text-[#004E89]"></h1>
            <p id="header-subtitle" class="text-xl text-[#0077B6] mt-2"></p>
            <div class="mt-6">
                <button id="download-pdf-btn" class="inline-block bg-[#0077B6] text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-[#004E89] transition-colors text-lg">
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <aside class="lg:col-span-4 xl:col-span-3">
                <div class="bg-white p-6 rounded-xl shadow-lg sticky top-8 space-y-8">
                    <div id="personal-details">
                        <h3 id="personal-details-title" class="text-xl font-bold text-[#004E89] mb-4 border-b-2 border-[#90E0EF] pb-2"></h3>
                        <div class="space-y-2 text-gray-700">
                            <p><strong id="phone-label"></strong> <span id="phone-value"></span></p>
                            <p><strong id="email-label"></strong> <span id="email-value"></span></p>
                            <p><strong id="location-label"></strong> <span id="location-value"></span></p>
                        </div>
                    </div>

                    <div id="github-section">
                        <h3 id="github-title" class="text-xl font-bold text-[#004E89] mb-4 border-b-2 border-[#90E0EF] pb-2"></h3>
                        <p id="github-text" class="text-gray-600 text-sm mb-4"></p>
                        <a href="https://github.com/alvarosola1/cv_asola" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center w-full bg-[#24292e] text-white font-bold py-2 px-4 rounded-lg hover:bg-[#333] transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.49.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.378.203 2.398.1 2.65.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.943.359.308.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd" />
                            </svg>
                            <span>Ver en GitHub</span>
                        </a>
                    </div>

                    <div id="education-certifications">
                        <h3 id="education-title" class="text-xl font-bold text-[#004E89] mb-4 border-b-2 border-[#90E0EF] pb-2"></h3>
                        <div class="space-y-3 text-gray-700">
                            <!-- Content will be injected by JS -->
                        </div>
                    </div>
                </div>
            </aside>

            <div class="lg:col-span-8 xl:col-span-9">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 id="experience-title" class="text-2xl font-bold text-[#004E89] mb-4 border-b-2 border-[#90E0EF] pb-2"></h2>
                    <p id="experience-description" class="text-gray-600 mb-6"></p>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-8">
                        <div id="timeline-panel" class="md:col-span-2">
                             <div id="timeline" class="space-y-4"></div>
                        </div>
                        <div id="details-panel" class="md:col-span-3 bg-gray-50 p-6 rounded-xl border min-h-[300px]">
                            <h3 id="details-title" class="text-2xl font-bold text-[#004E89] mb-2"></h3>
                            <p id="details-subtitle" class="text-md text-[#0077B6] font-semibold mb-4"></p>
                            <div id="details-content" class="space-y-2 text-gray-700"></div>
                            <div id="gemini-buttons" class="mt-6 pt-4 border-t space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center mt-12 py-6 border-t border-gray-200">
        <p id="contact-title" class="text-lg text-[#0077B6]"></p>
        <p id="contact-info" class="text-[#004E89] font-semibold"></p>
    </footer>

    <div id="gemini-modal" class="gemini-modal">
        <div class="gemini-modal-content">
            <span id="close-modal" class="absolute top-4 right-6 text-3xl text-gray-500 hover:text-gray-800 cursor-pointer">&times;</span>
            <h3 id="modal-title" class="text-2xl font-bold text-[#004E89] mb-4"></h3>
            <div id="modal-body" class="prose"></div>
        </div>
    </div>

    <script>
        let activeJobId = 1;

        const timelineContainer = document.getElementById('timeline');
        const detailsTitle = document.getElementById('details-title');
        const detailsSubtitle = document.getElementById('details-subtitle');
        const detailsContent = document.getElementById('details-content');
        const geminiButtonsContainer = document.getElementById('gemini-buttons');
        const modal = document.getElementById('gemini-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const closeModalBtn = document.getElementById('close-modal');
        const educationCertificationsContainer = document.getElementById('education-certifications').querySelector('.space-y-3');

        async function callGeminiApi(prompt, retries = 3, delay = 1000) {
            const apiKey = typeof GEMINI_API_KEY !== 'undefined' ? GEMINI_API_KEY : '';
            
            if (!apiKey || apiKey === "REEMPLAZA_ESTO_CON_TU_API_KEY") {
                const errorMessage = `
                    <div class="text-center text-red-600 p-4">
                        <p class="font-bold text-lg mb-2">Error: Falta la API Key de Gemini.</p>
                        <p>Para usar esta funci√≥n, necesitas una clave de API de Google.</p>
                        <ol class="list-decimal list-inside text-left mx-auto max-w-md mt-2 text-sm text-gray-600">
                            <li>Crea un archivo llamado <strong>config.js</strong> en la ra√≠z del proyecto.</li>
                            <li>A√±ade el contenido: <code>const GEMINI_API_KEY = "tu_clave_aqui";</code></li>
                        </ol>
                        <p class="mt-4"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">Consigue una clave gratuita en Google AI Studio</a></p>
                    </div>`;
                updateModalContent(errorMessage, false);
                return;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callGeminiApi(prompt, retries - 1, delay * 2);
                    }
                     throw new Error(`Error de API: ${response.status}`);
                }
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error en la llamada a Gemini:", error);
                return "Hubo un error al contactar con la IA. Por favor, int√©ntalo de nuevo m√°s tarde.";
            }
        }
        
        function formatApiResponse(text) {
            if (!text) return "";

            const lines = text.split('\n');
            let html = '';
            let inList = false;
            let listType = '';

            for (const line of lines) {
                let processedLine = line.trim();
                if (processedLine === '') continue;

                let isListItem = false;
                let currentListType = '';

                if (processedLine.startsWith('### ')) {
                    processedLine = `<h3 class="text-lg font-bold text-[#004E89] mt-4 mb-2">${processedLine.substring(4)}</h3>`;
                }
                else if (/^\s*\d+\.\s/.test(processedLine)) {
                    isListItem = true;
                    currentListType = 'ol';
                    processedLine = `<li>${processedLine.replace(/^\s*\d+\.\s*/, '')}</li>`;
                }
                else if (/^\s*[\*-]\s/.test(processedLine)) {
                    isListItem = true;
                    currentListType = 'ul';
                    processedLine = `<li>${processedLine.replace(/^\s*[\*-]\s*/, '')}</li>`;
                }

                if (isListItem) {
                    if (!inList || listType !== currentListType) {
                        if (inList) html += `</${listType}>`;
                        listType = currentListType;
                        html += `<${listType} class="list-inside space-y-2 ${listType === 'ol' ? 'list-decimal' : 'list-disc'}">`;
                        inList = true;
                    }
                } else {
                    if (inList) {
                        html += `</${listType}>`;
                        inList = false;
                    }
                }

                processedLine = processedLine.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-800">$1</strong>');
                
                if (!isListItem && !processedLine.startsWith('<h')) {
                    processedLine = `<p class="mb-2">${processedLine}</p>`;
                }

                html += processedLine;
            }

            if (inList) {
                html += `</${listType}>`;
            }

            return html.replace(/<p><\/p>/g, '');
        }

        function showModal(title, content = '') {
            modalTitle.textContent = title;
            modalBody.innerHTML = content || '<div class="loader"></div>';
            modal.style.display = 'block';
        }

        function updateModalContent(content, shouldFormat = true) {
            modalBody.innerHTML = `<div class="text-gray-700 space-y-4">${shouldFormat ? formatApiResponse(content) : content}</div>`;
        }
        
        closeModalBtn.onclick = () => modal.style.display = "none";
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
        
        function loadImageAsBase64(url) {
            return new Promise((resolve, reject) => {
                fetch(url)
                    .then(response => response.blob())
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    })
                    .catch(reject);
            });
        }

        async function generatePdf(cvData) {
            downloadPdfBtn.disabled = true;
            downloadPdfBtn.innerHTML = 'Generando PDF... ‚è≥';

            try {
                const profileImageBase64 = await loadImageAsBase64('foto_cv.jpg');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                const MARGIN = 15;
                const PAGE_WIDTH = doc.internal.pageSize.getWidth();
                const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
                const FONT_SIZE_NORMAL = 9;
                const FONT_SIZE_SMALL = 8;
                const FONT_SIZE_H1 = 18;
                const FONT_SIZE_H2 = 12;
                const LINE_HEIGHT = 5;
                const MAIN_COL_WIDTH = (PAGE_WIDTH - MARGIN * 3) * 0.65;
                const SIDE_COL_WIDTH = (PAGE_WIDTH - MARGIN * 3) * 0.35;
                
                let y = MARGIN;

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(FONT_SIZE_H1);
                doc.setTextColor('#004E89');
                doc.text(cvData.personal.name, MARGIN, y);
                y += LINE_HEIGHT * 1.5;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(FONT_SIZE_NORMAL);
                doc.setTextColor('#0077B6');
                doc.text(cvData.personal.title, MARGIN, y);
                
                let headerMaxY = y;
                if (profileImageBase64) {
                    // --- Ajuste de la imagen ---
                    const imgWidth = 25; // M√°s estrecha
                    const imgHeight = 30; // Mantenemos la altura
                    const imgX = PAGE_WIDTH - MARGIN - imgWidth;
                    const imgY = MARGIN;
                    doc.addImage(profileImageBase64, 'JPEG', imgX, imgY, imgWidth, imgHeight);
                    headerMaxY = Math.max(y, imgY + imgHeight);
                }
                
                y = headerMaxY + 10;
                
                let mainY = y;
                let sideY = y;
                const sideX = MARGIN + MAIN_COL_WIDTH + MARGIN;
                
                function checkPageBreak(neededHeight, isMainCol) {
                    let currentY = isMainCol ? mainY : sideY;
                    if (currentY + neededHeight > PAGE_HEIGHT - MARGIN) {
                        doc.addPage();
                        mainY = MARGIN;
                        sideY = MARGIN;
                        return true;
                    }
                    return false;
                }

                doc.setFont('helvetica', 'bold').setFontSize(FONT_SIZE_H2).setTextColor('#004E89');
                doc.text('Contacto', sideX, sideY);
                sideY += LINE_HEIGHT * 0.8;
                doc.setDrawColor('#90E0EF').line(sideX, sideY, PAGE_WIDTH - MARGIN, sideY);
                sideY += LINE_HEIGHT;
                
                doc.setFont('helvetica', 'normal').setFontSize(FONT_SIZE_SMALL).setTextColor('#333333');
                doc.text(`T: ${cvData.personal.phone}`, sideX, sideY); sideY += LINE_HEIGHT * 0.8;
                doc.text(`E: ${cvData.personal.email}`, sideX, sideY); sideY += LINE_HEIGHT * 0.8;
                doc.text(`L: ${cvData.personal.location}`, sideX, sideY); sideY += LINE_HEIGHT * 1.5;

                doc.setFont('helvetica', 'bold').setFontSize(FONT_SIZE_H2).setTextColor('#004E89');
                doc.text('Formaci√≥n', sideX, sideY);
                sideY += LINE_HEIGHT * 0.8;
                doc.line(sideX, sideY, PAGE_WIDTH - MARGIN, sideY);
                sideY += LINE_HEIGHT;
                
                doc.setFont('helvetica', 'bold').setFontSize(FONT_SIZE_SMALL);
                const eduTitleLines = doc.splitTextToSize(cvData.education.title, SIDE_COL_WIDTH);
                doc.text(eduTitleLines, sideX, sideY); sideY += eduTitleLines.length * (LINE_HEIGHT * 0.8);
                doc.setFont('helvetica', 'normal');
                doc.text(`${cvData.education.institution} | ${cvData.education.period}`, sideX, sideY); sideY += LINE_HEIGHT * 1.5;

                doc.setFont('helvetica', 'bold').setFontSize(FONT_SIZE_H2).setTextColor('#004E89');
                doc.text('Certificaciones', sideX, sideY);
                sideY += LINE_HEIGHT * 0.8;
                doc.line(sideX, sideY, PAGE_WIDTH - MARGIN, sideY);
                sideY += LINE_HEIGHT;

                doc.setFont('helvetica', 'normal').setFontSize(FONT_SIZE_SMALL);
                cvData.certifications.forEach(cert => {
                    const certLines = doc.splitTextToSize(`‚Ä¢ ${cert}`, SIDE_COL_WIDTH - 2);
                    checkPageBreak(certLines.length * (LINE_HEIGHT * 0.8), false);
                    doc.text(certLines, sideX + 2, sideY);
                    sideY += certLines.length * (LINE_HEIGHT * 0.8);
                });

                doc.setFont('helvetica', 'bold').setFontSize(FONT_SIZE_H2).setTextColor('#004E89');
                doc.text('Perfil Profesional', MARGIN, mainY);
                mainY += LINE_HEIGHT * 0.8;
                doc.line(MARGIN, mainY, MARGIN + MAIN_COL_WIDTH, mainY);
                mainY += LINE_HEIGHT;

                doc.setFont('helvetica', 'normal').setFontSize(FONT_SIZE_NORMAL).setTextColor('#333333');
                const profileText = doc.splitTextToSize(cvData.profile, MAIN_COL_WIDTH);
                doc.text(profileText, MARGIN, mainY);
                mainY += profileText.length * LINE_HEIGHT + LINE_HEIGHT;

                doc.setFont('helvetica', 'bold').setFontSize(FONT_SIZE_H2).setTextColor('#004E89');
                doc.text('Experiencia Profesional', MARGIN, mainY);
                mainY += LINE_HEIGHT * 0.8;
                doc.line(MARGIN, mainY, MARGIN + MAIN_COL_WIDTH, mainY);
                mainY += LINE_HEIGHT;

                cvData.jobs.forEach(job => {
                    let jobBlockHeight = (2 * LINE_HEIGHT) + (job.description.length * LINE_HEIGHT * 0.9);
                    checkPageBreak(jobBlockHeight, true);

                    doc.setFont('helvetica', 'bold').setFontSize(FONT_SIZE_NORMAL).setTextColor('#004E89');
                    doc.text(job.role, MARGIN, mainY);
                    mainY += LINE_HEIGHT * 0.9;

                    doc.setFont('helvetica', 'normal').setTextColor('#0077B6');
                    doc.text(`${job.company} | ${job.period}`, MARGIN, mainY);
                    mainY += LINE_HEIGHT;

                    doc.setFont('helvetica', 'normal').setTextColor('#333333');
                    job.description.forEach(desc => {
                        const descLines = doc.splitTextToSize(`‚Ä¢ ${desc}`, MAIN_COL_WIDTH - 5);
                        checkPageBreak(descLines.length * LINE_HEIGHT, true);
                        doc.text(descLines, MARGIN + 5, mainY);
                        mainY += descLines.length * (LINE_HEIGHT * 0.9);
                    });
                    mainY += LINE_HEIGHT;
                });

                doc.save('CV_Alvaro_Sola_Martinez.pdf');

            } catch (error) {
                console.error("Error al generar el PDF:", error);
                alert("Hubo un error al generar el PDF. Por favor, int√©ntalo de nuevo.");
            } finally {
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.innerHTML = 'Descargar CV (PDF) üìÑ';
            }
        }

        function renderGeminiButtons(jobId, cvData) {
            geminiButtonsContainer.innerHTML = '';
            const buttons = [
                { text: '‚ú® Sugerir Preguntas de Entrevista', handler: () => handleInterviewQuestions(jobId, cvData) },
                { text: '‚ú® Resumir para Manager', handler: () => handleManagerSummary(jobId, cvData) },
                { text: '‚ú® Redactar Email de Contacto', handler: () => handleContactEmail(jobId, cvData) },
                { text: 'ü§ñ Analizar Nueva Habilidad', handler: () => handleAnalyzeSkill(cvData) }
            ];

            buttons.forEach(btnInfo => {
                 const button = document.createElement('button');
                button.innerHTML = btnInfo.text;
                button.className = 'bg-[#004E89] text-white font-bold py-2 px-4 rounded-lg w-full hover:bg-[#0077B6] transition-colors text-sm';
                button.onclick = btnInfo.handler;
                geminiButtonsContainer.appendChild(button);
            });
        }

        async function handleInterviewQuestions(jobId, cvData) {
            const job = cvData.jobs.find(j => j.id === jobId);
            if (!job) return;
            showModal(`Preguntas para: ${job.role}`);
            const prompt = `Para el puesto de "${job.role}" con responsabilidades como "${job.description.join(', ')}" y usando tecnolog√≠as como "${job.technologies.join(', ')}", genera 5 preguntas de entrevista t√©cnicas y 3 conductuales relevantes. Formatea la respuesta en Markdown con t√≠tulos (###) y listas.`;
            const response = await callGeminiApi(prompt);
            if (response) updateModalContent(response);
        }
        
        async function handleManagerSummary(jobId, cvData) {
            const job = cvData.jobs.find(j => j.id === jobId);
            if (!job) return;
            showModal(`Resumen para Manager: ${job.role}`);
            const prompt = `Para el puesto de '${job.role}' en '${job.company}', con responsabilidades como '${job.description.join('. ')}', resume los logros y el impacto en el negocio en 3 puntos clave para un manager no t√©cnico. Enf√≥cate en el valor aportado, no en los detalles t√©cnicos. Formatea la respuesta en Markdown con una lista.`;
            const response = await callGeminiApi(prompt);
            if (response) updateModalContent(response);
        }

        async function handleContactEmail(jobId, cvData) {
            const job = cvData.jobs.find(j => j.id === jobId);
            if (!job) return;
            showModal(`Borrador de Email para: ${job.role}`);
            const prompt = `Act√∫a como un reclutador de TI. Redacta un email profesional y conciso para contactar a √Ålvaro Sola Mart√≠nez sobre una oportunidad laboral relevante a su experiencia como '${job.role}' en '${job.company}'. Menciona una o dos tecnolog√≠as clave de ese puesto como '${job.technologies.slice(0,2).join(', ')}' para personalizar el mensaje. El email debe ser amigable, directo y terminar con un placeholder para el nombre del reclutador. Formatea la respuesta en Markdown.`;
            const response = await callGeminiApi(prompt);
            if (response) updateModalContent(response);
        }
        
        async function handleAnalyzeSkill(cvData) {
            const skillName = prompt("Introduce el nombre de una tecnolog√≠a o habilidad para analizar (e.g., 'AWS', 'Go', 'FinOps'):");
            if (!skillName) return;

            showModal(`Analizando c√≥mo '${skillName}' encaja en el perfil...`);
            const promptContext = `Este es el perfil de un Ingeniero DevOps y Arquitecto de Sistemas:
            - Perfil: ${cvData.profile}
            - Experiencia: ${cvData.jobs.map(j => `${j.role} en ${j.company} usando ${j.technologies.join(', ')}`).join('; ')}
            - Certificaciones: ${cvData.certifications.join(', ')}.`;
            
            const promptQuestion = `Basado en el perfil anterior, analiza c√≥mo la habilidad o tecnolog√≠a '${skillName}' complementar√≠a o potenciar√≠a su carrera. Explica su relevancia en el mercado actual para un rol DevOps/Cloud y sugiere 1-2 pasos concretos que podr√≠a dar para adquirirla o demostrarla. Formatea la respuesta en Markdown con t√≠tulos y listas.`;

            const fullPrompt = `${promptContext}\n\n${promptQuestion}`;
            const response = await callGeminiApi(fullPrompt);
            if (response) updateModalContent(response);
        }

        function renderTimeline(cvData) {
            timelineContainer.innerHTML = cvData.jobs.map(job => `
                <div class="timeline-item border-l-4 border-gray-200 p-4 rounded-r-lg bg-white shadow-sm hover:bg-gray-100 ${job.id === activeJobId ? 'active' : ''}" data-job-id="${job.id}">
                    <p class="font-bold text-[#004E89]">${job.role}</p>
                    <p class="text-sm text-gray-600">${job.company}</p>
                    <p class="text-xs text-gray-500 mt-1">${job.period}</p>
                </div>
            `).join('');
        }

        function renderDetails(jobId, cvData) {
            const job = cvData.jobs.find(j => j.id === jobId);
            if (!job) return;
            activeJobId = jobId;
            detailsTitle.textContent = job.role;
            detailsSubtitle.textContent = `${job.company} | ${job.period}`;
            detailsContent.innerHTML = `
                <p class="font-semibold mb-3">Responsabilidades y Logros:</p>
                <ul class="list-disc list-inside space-y-2 mb-4">
                    ${job.description.map(d => `<li>${d}</li>`).join('')}
                </ul>
                <p class="font-semibold mb-2">Tecnolog√≠as Clave:</p>
                <div class="flex flex-wrap gap-2">
                    ${job.technologies.map(t => `<span class="bg-[#90E0EF] text-[#004E89] text-xs font-bold px-2 py-1 rounded-full">${t}</span>`).join('')}
                </div>
            `;
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.classList.toggle('active', parseInt(item.dataset.jobId) === jobId);
            });
            renderGeminiButtons(jobId, cvData);
        }
        
        function handleTimelineClick(e, cvData) {
            const item = e.target.closest('.timeline-item');
            if (!item) return;
            const jobId = parseInt(item.dataset.jobId);
            renderDetails(jobId, cvData);
        }
        
        function renderEducationAndCerts(cvData) {
            const edu = cvData.education;
            let html = `<div class="mb-4"><p class="font-bold">${edu.title}</p><p class="text-sm">${edu.institution} | ${edu.period}</p></div>`;
            html += cvData.certifications.map(cert => `<p class="text-sm">‚Ä¢ ${cert}</p>`).join('');
            educationCertificationsContainer.innerHTML = html;
        }

        function populateStaticStrings(strings, cvData) {
            document.getElementById('header-title').textContent = strings.headerTitle;
            document.getElementById('header-subtitle').textContent = strings.headerSubtitle;
            document.getElementById('download-pdf-btn').innerHTML = strings.downloadButton;
            document.getElementById('personal-details-title').textContent = strings.personalDetailsTitle;
            document.getElementById('phone-label').textContent = strings.phoneLabel;
            document.getElementById('phone-value').textContent = cvData.personal.phone;
            document.getElementById('email-label').textContent = strings.emailLabel;
            document.getElementById('email-value').textContent = cvData.personal.email;
            document.getElementById('location-label').textContent = strings.locationLabel;
            document.getElementById('location-value').textContent = cvData.personal.location;
            document.getElementById('education-title').textContent = strings.educationTitle;
            document.getElementById('experience-title').textContent = strings.experienceTitle;
            document.getElementById('experience-description').textContent = strings.experienceDescription;
            document.getElementById('contact-title').textContent = strings.contactTitle;
            document.getElementById('contact-info').textContent = strings.contactInfo;
            document.getElementById('github-title').textContent = strings.githubSectionTitle;
            document.getElementById('github-text').textContent = strings.githubSectionText;
        }

        async function main() {
            try {
                const [cvResponse, stringsResponse] = await Promise.all([
                    fetch('./data/cvData.json'),
                    fetch('./data/strings.json')
                ]);
                
                if (!cvResponse.ok || !stringsResponse.ok) {
                    throw new Error('Network response was not ok.');
                }

                const cvData = await cvResponse.json();
                const strings = await stringsResponse.json();
                
                populateStaticStrings(strings, cvData);
                renderTimeline(cvData);
                renderDetails(1, cvData);
                renderEducationAndCerts(cvData);
                
                timelineContainer.addEventListener('click', (e) => handleTimelineClick(e, cvData));
                downloadPdfBtn.addEventListener('click', () => generatePdf(cvData));

            } catch (error) {
                console.error("Error al cargar los datos:", error);
                document.body.innerHTML = '<p class="text-center text-red-500 p-8">Error al cargar los datos del CV. Por favor, aseg√∫rate de que los archivos data/cvData.json y data/strings.json existen y son accesibles. Este error suele ocurrir al abrir el archivo HTML directamente en el navegador. Intenta usar un servidor local.</p>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
